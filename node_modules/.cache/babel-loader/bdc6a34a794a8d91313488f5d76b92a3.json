{"ast":null,"code":"'use strict';\n\nconst ConsumableBuffer = require('./consumable-buffer');\n\nmodule.exports = function wrapHash(hashFn) {\n  return function hashing(value) {\n    if (value instanceof InfiniteHash) {\n      // already a hash. return it\n      return value;\n    } else {\n      return new InfiniteHash(value, hashFn);\n    }\n  };\n};\n\nclass InfiniteHash {\n  constructor(value, hashFn) {\n    if (typeof value !== 'string' && !Buffer.isBuffer(value)) {\n      throw new Error('can only hash strings or buffers');\n    }\n\n    this._value = value;\n    this._hashFn = hashFn;\n    this._depth = -1;\n    this._availableBits = 0;\n    this._currentBufferIndex = 0;\n    this._buffers = [];\n  }\n\n  async take(bits) {\n    let pendingBits = bits;\n\n    while (this._availableBits < pendingBits) {\n      await this._produceMoreBits();\n    }\n\n    let result = 0;\n\n    while (pendingBits > 0) {\n      const hash = this._buffers[this._currentBufferIndex];\n      const available = Math.min(hash.availableBits(), pendingBits);\n      const took = hash.take(available);\n      result = (result << available) + took;\n      pendingBits -= available;\n      this._availableBits -= available;\n\n      if (hash.availableBits() === 0) {\n        this._currentBufferIndex++;\n      }\n    }\n\n    return result;\n  }\n\n  untake(bits) {\n    let pendingBits = bits;\n\n    while (pendingBits > 0) {\n      const hash = this._buffers[this._currentBufferIndex];\n      const availableForUntake = Math.min(hash.totalBits() - hash.availableBits(), pendingBits);\n      hash.untake(availableForUntake);\n      pendingBits -= availableForUntake;\n      this._availableBits += availableForUntake;\n\n      if (this._currentBufferIndex > 0 && hash.totalBits() === hash.availableBits()) {\n        this._depth--;\n        this._currentBufferIndex--;\n      }\n    }\n  }\n\n  async _produceMoreBits() {\n    this._depth++;\n    const value = this._depth ? this._value + this._depth : this._value;\n    const hashValue = await this._hashFn(value);\n    const buffer = new ConsumableBuffer(hashValue);\n\n    this._buffers.push(buffer);\n\n    this._availableBits += buffer.availableBits();\n  }\n\n}","map":null,"metadata":{},"sourceType":"script"}