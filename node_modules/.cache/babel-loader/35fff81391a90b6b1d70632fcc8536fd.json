{"ast":null,"code":"const io = require('orbit-db-io');\n\nconst Buffer = require('safe-buffer').Buffer; //const AccessController = require('./access-controller-interface')\n\n\nconst type = 'legacy-ipfs-3box';\n\nclass LegacyIPFS3BoxAccessController {\n  constructor(ipfs, options) {\n    //super()\n    this._ipfs = ipfs;\n    this._write = Array.from(options.write || []);\n    this._resolver = options.resolver;\n  } // Returns the type of the access controller\n\n\n  static get type() {\n    return type;\n  } // Return a Set of keys that have `access` capability\n\n\n  get write() {\n    return this._write;\n  }\n\n  async canAppend(entry, identityProvider) {\n    // Allow if access list contain the writer's publicKey or is '*'\n    const publicKey = entry.v === 0 ? entry.key : await this._publicKeyFromDID(entry.identity.id);\n\n    if (this.write.includes(publicKey) || this.write.includes('*')) {\n      return entry.v === 0 ? true : await identityProvider.verifyIdentity(entry.identity);\n    }\n\n    return false;\n  }\n\n  async load(address) {\n    // Transform '/ipfs/QmPFtHi3cmfZerxtH9ySLdzpg1yFhocYDZgEZywdUXHxFU'\n    // to 'QmPFtHi3cmfZerxtH9ySLdzpg1yFhocYDZgEZywdUXHxFU'\n    if (address.indexOf('/ipfs') === 0) {\n      address = address.split('/')[2];\n    }\n\n    try {\n      const access = await io.read(this._ipfs, address);\n      this._write = access.write;\n    } catch (e) {\n      console.log('LegacyIPFS3BoxAccessController.load ERROR:', e);\n    }\n  }\n\n  async save(options) {\n    let cid;\n    const access = {\n      admin: [],\n      write: this.write,\n      read: []\n    };\n\n    try {\n      cid = await io.write(this._ipfs, 'raw', Buffer.from(JSON.stringify(access, null, 2)), {\n        format: 'dag-pb'\n      });\n    } catch (e) {\n      console.log('LegacyIPFS3BoxAccessController.save ERROR:', e);\n    } // return the manifest data\n\n\n    return {\n      address: cid,\n      skipManifest: true\n    };\n  }\n\n  static async create(orbitdb, options = {}) {\n    options = { ...options,\n      ...{\n        write: options.write || [orbitdb.identity.publicKey]\n      }\n    };\n    return new LegacyIPFS3BoxAccessController(orbitdb._ipfs, options);\n  }\n\n  async _publicKeyFromDID(did) {\n    // TODO - this should look at authentication keys and get publicKey from that\n    const doc = await this._resolver.resolve(did);\n    return doc.publicKey.find(entry => {\n      const id = entry.id.split('#');\n      return id[0] === doc.id && (id[1] === 'subSigningKey' || id[1] === 'signingKey');\n    }).publicKeyHex;\n  }\n\n}\n\nmodule.exports = LegacyIPFS3BoxAccessController;","map":null,"metadata":{},"sourceType":"script"}