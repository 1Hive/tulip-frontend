{"ast":null,"code":"'use strict';\n\nconst {\n  Adapter,\n  Errors\n} = require('interface-datastore');\n\nconst log = require('debug')('datastore:core:tiered');\n/**\n * A datastore that can combine multiple stores. Puts and deletes\n * will write through to all datastores. Has and get will\n * try each store sequentially. Query will always try the\n * last one first.\n *\n */\n\n\nclass TieredDatastore extends Adapter {\n  constructor(stores) {\n    super();\n    this.stores = stores.slice();\n  }\n\n  async open() {\n    try {\n      await Promise.all(this.stores.map(store => store.open()));\n    } catch (err) {\n      throw Errors.dbOpenFailedError();\n    }\n  }\n\n  async put(key, value) {\n    try {\n      await Promise.all(this.stores.map(store => store.put(key, value)));\n    } catch (err) {\n      throw Errors.dbWriteFailedError();\n    }\n  }\n\n  async get(key, options) {\n    for (const store of this.stores) {\n      try {\n        const res = await store.get(key, options);\n        if (res) return res;\n      } catch (err) {\n        log(err);\n      }\n    }\n\n    throw Errors.notFoundError();\n  }\n\n  async has(key, options) {\n    for (const s of this.stores) {\n      if (await s.has(key, options)) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  async delete(key, options) {\n    try {\n      await Promise.all(this.stores.map(store => store.delete(key, options)));\n    } catch (err) {\n      throw Errors.dbDeleteFailedError();\n    }\n  }\n\n  async close() {\n    await Promise.all(this.stores.map(store => store.close()));\n  }\n\n  batch() {\n    const batches = this.stores.map(store => store.batch());\n    return {\n      put: (key, value) => {\n        batches.forEach(b => b.put(key, value));\n      },\n      delete: key => {\n        batches.forEach(b => b.delete(key));\n      },\n      commit: async options => {\n        for (const batch of batches) {\n          await batch.commit(options);\n        }\n      }\n    };\n  }\n\n  query(q, options) {\n    return this.stores[this.stores.length - 1].query(q, options);\n  }\n\n}\n\nmodule.exports = TieredDatastore;","map":null,"metadata":{},"sourceType":"script"}