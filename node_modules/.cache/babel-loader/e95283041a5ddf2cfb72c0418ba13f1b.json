{"ast":null,"code":"'use strict';\n\nvar _createForOfIteratorHelper = require(\"/Users/fabianmolina/Documents/1hive/tulip-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\nvar _regeneratorRuntime = require(\"/Users/fabianmolina/Documents/1hive/tulip-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"/Users/fabianmolina/Documents/1hive/tulip-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _classCallCheck = require(\"/Users/fabianmolina/Documents/1hive/tulip-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/fabianmolina/Documents/1hive/tulip-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar SparseArray = require('sparse-array');\n\nvar wrapHash = require('./consumable-hash');\n\nvar defaultOptions = {\n  bits: 8\n};\n\nvar Bucket = /*#__PURE__*/function () {\n  function Bucket(options, parent, posAtParent) {\n    _classCallCheck(this, Bucket);\n\n    this._options = Object.assign({}, defaultOptions, options);\n    this._popCount = 0;\n    this._parent = parent;\n    this._posAtParent = posAtParent;\n\n    if (!this._options.hashFn) {\n      throw new Error('please define an options.hashFn');\n    } // make sure we only wrap options.hashFn once in the whole tree\n\n\n    if (!this._options.hash) {\n      this._options.hash = wrapHash(this._options.hashFn);\n    }\n\n    this._children = new SparseArray();\n  }\n\n  _createClass(Bucket, [{\n    key: \"put\",\n    value: function () {\n      var _put = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(key, value) {\n        var place;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return this._findNewBucketAndPos(key);\n\n              case 2:\n                place = _context.sent;\n                _context.next = 5;\n                return place.bucket._putAt(place, key, value);\n\n              case 5:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function put(_x, _x2) {\n        return _put.apply(this, arguments);\n      }\n\n      return put;\n    }()\n  }, {\n    key: \"get\",\n    value: function () {\n      var _get = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(key) {\n        var child;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return this._findChild(key);\n\n              case 2:\n                child = _context2.sent;\n\n                if (!child) {\n                  _context2.next = 5;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", child.value);\n\n              case 5:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function get(_x3) {\n        return _get.apply(this, arguments);\n      }\n\n      return get;\n    }()\n  }, {\n    key: \"del\",\n    value: function () {\n      var _del = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(key) {\n        var place, child;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return this._findPlace(key);\n\n              case 2:\n                place = _context3.sent;\n                child = place.bucket._at(place.pos);\n\n                if (child && child.key === key) {\n                  place.bucket._delAt(place.pos);\n                }\n\n              case 5:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function del(_x4) {\n        return _del.apply(this, arguments);\n      }\n\n      return del;\n    }()\n  }, {\n    key: \"leafCount\",\n    value: function leafCount() {\n      return this._children.compactArray().reduce(function (acc, child) {\n        if (child instanceof Bucket) {\n          return acc + child.leafCount();\n        }\n\n        return acc + 1;\n      }, 0);\n    }\n  }, {\n    key: \"childrenCount\",\n    value: function childrenCount() {\n      return this._children.length;\n    }\n  }, {\n    key: \"onlyChild\",\n    value: function onlyChild() {\n      return this._children.get(0);\n    }\n  }, {\n    key: \"eachLeafSeries\",\n    value: /*#__PURE__*/_regeneratorRuntime.mark(function eachLeafSeries() {\n      var children, _iterator, _step, child, _iterator2, _step2, c2;\n\n      return _regeneratorRuntime.wrap(function eachLeafSeries$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              children = this._children.compactArray();\n              _iterator = _createForOfIteratorHelper(children);\n              _context4.prev = 2;\n\n              _iterator.s();\n\n            case 4:\n              if ((_step = _iterator.n()).done) {\n                _context4.next = 30;\n                break;\n              }\n\n              child = _step.value;\n\n              if (!(child instanceof Bucket)) {\n                _context4.next = 26;\n                break;\n              }\n\n              _iterator2 = _createForOfIteratorHelper(child.eachLeafSeries());\n              _context4.prev = 8;\n\n              _iterator2.s();\n\n            case 10:\n              if ((_step2 = _iterator2.n()).done) {\n                _context4.next = 16;\n                break;\n              }\n\n              c2 = _step2.value;\n              _context4.next = 14;\n              return c2;\n\n            case 14:\n              _context4.next = 10;\n              break;\n\n            case 16:\n              _context4.next = 21;\n              break;\n\n            case 18:\n              _context4.prev = 18;\n              _context4.t0 = _context4[\"catch\"](8);\n\n              _iterator2.e(_context4.t0);\n\n            case 21:\n              _context4.prev = 21;\n\n              _iterator2.f();\n\n              return _context4.finish(21);\n\n            case 24:\n              _context4.next = 28;\n              break;\n\n            case 26:\n              _context4.next = 28;\n              return child;\n\n            case 28:\n              _context4.next = 4;\n              break;\n\n            case 30:\n              _context4.next = 35;\n              break;\n\n            case 32:\n              _context4.prev = 32;\n              _context4.t1 = _context4[\"catch\"](2);\n\n              _iterator.e(_context4.t1);\n\n            case 35:\n              _context4.prev = 35;\n\n              _iterator.f();\n\n              return _context4.finish(35);\n\n            case 38:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, eachLeafSeries, this, [[2, 32, 35, 38], [8, 18, 21, 24]]);\n    })\n  }, {\n    key: \"serialize\",\n    value: function serialize(map, reduce) {\n      // serialize to a custom non-sparse representation\n      return reduce(this._children.reduce(function (acc, child, index) {\n        if (child) {\n          if (child instanceof Bucket) {\n            acc.push(child.serialize(map, reduce));\n          } else {\n            acc.push(map(child, index));\n          }\n        }\n\n        return acc;\n      }, []));\n    }\n  }, {\n    key: \"asyncTransform\",\n    value: function asyncTransform(asyncMap, asyncReduce) {\n      return asyncTransformBucket(this, asyncMap, asyncReduce);\n    }\n  }, {\n    key: \"toJSON\",\n    value: function toJSON() {\n      return this.serialize(mapNode, reduceNodes);\n    }\n  }, {\n    key: \"prettyPrint\",\n    value: function prettyPrint() {\n      return JSON.stringify(this.toJSON(), null, '  ');\n    }\n  }, {\n    key: \"tableSize\",\n    value: function tableSize() {\n      return Math.pow(2, this._options.bits);\n    }\n  }, {\n    key: \"_findChild\",\n    value: function () {\n      var _findChild2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(key) {\n        var result, child;\n        return _regeneratorRuntime.wrap(function _callee4$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                _context5.next = 2;\n                return this._findPlace(key);\n\n              case 2:\n                result = _context5.sent;\n                child = result.bucket._at(result.pos);\n\n                if (!(child && child.key === key)) {\n                  _context5.next = 6;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\", child);\n\n              case 6:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function _findChild(_x5) {\n        return _findChild2.apply(this, arguments);\n      }\n\n      return _findChild;\n    }()\n  }, {\n    key: \"_findPlace\",\n    value: function () {\n      var _findPlace2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(key) {\n        var hashValue, index, child;\n        return _regeneratorRuntime.wrap(function _callee5$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                hashValue = this._options.hash(key);\n                _context6.next = 3;\n                return hashValue.take(this._options.bits);\n\n              case 3:\n                index = _context6.sent;\n                child = this._children.get(index);\n\n                if (!(child instanceof Bucket)) {\n                  _context6.next = 7;\n                  break;\n                }\n\n                return _context6.abrupt(\"return\", child._findPlace(hashValue));\n\n              case 7:\n                return _context6.abrupt(\"return\", {\n                  bucket: this,\n                  pos: index,\n                  hash: hashValue\n                });\n\n              case 8:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function _findPlace(_x6) {\n        return _findPlace2.apply(this, arguments);\n      }\n\n      return _findPlace;\n    }()\n  }, {\n    key: \"_findNewBucketAndPos\",\n    value: function () {\n      var _findNewBucketAndPos2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(key) {\n        var place, child, bucket, newPlace;\n        return _regeneratorRuntime.wrap(function _callee6$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                _context7.next = 2;\n                return this._findPlace(key);\n\n              case 2:\n                place = _context7.sent;\n                child = place.bucket._at(place.pos);\n\n                if (!(child && child.key !== key)) {\n                  _context7.next = 12;\n                  break;\n                }\n\n                // conflict\n                bucket = new Bucket(this._options, place.bucket, place.pos);\n\n                place.bucket._putObjectAt(place.pos, bucket); // put the previous value\n\n\n                _context7.next = 9;\n                return bucket._findPlace(child.hash);\n\n              case 9:\n                newPlace = _context7.sent;\n\n                newPlace.bucket._putAt(newPlace, child.key, child.value);\n\n                return _context7.abrupt(\"return\", bucket._findNewBucketAndPos(place.hash));\n\n              case 12:\n                return _context7.abrupt(\"return\", place);\n\n              case 13:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function _findNewBucketAndPos(_x7) {\n        return _findNewBucketAndPos2.apply(this, arguments);\n      }\n\n      return _findNewBucketAndPos;\n    }()\n  }, {\n    key: \"_putAt\",\n    value: function _putAt(place, key, value) {\n      this._putObjectAt(place.pos, {\n        key: key,\n        value: value,\n        hash: place.hash\n      });\n    }\n  }, {\n    key: \"_putObjectAt\",\n    value: function _putObjectAt(pos, object) {\n      if (!this._children.get(pos)) {\n        this._popCount++;\n      }\n\n      this._children.set(pos, object);\n    }\n  }, {\n    key: \"_delAt\",\n    value: function _delAt(pos) {\n      if (this._children.get(pos)) {\n        this._popCount--;\n      }\n\n      this._children.unset(pos);\n\n      this._level();\n    }\n  }, {\n    key: \"_level\",\n    value: function _level() {\n      if (this._parent && this._popCount <= 1) {\n        if (this._popCount === 1) {\n          // remove myself from parent, replacing me with my only child\n          var onlyChild = this._children.find(exists);\n\n          if (!(onlyChild instanceof Bucket)) {\n            var hash = onlyChild.hash;\n            hash.untake(this._options.bits);\n            var place = {\n              pos: this._posAtParent,\n              hash: hash\n            };\n\n            this._parent._putAt(place, onlyChild.key, onlyChild.value);\n          }\n        } else {\n          this._parent._delAt(this._posAtParent);\n        }\n      }\n    }\n  }, {\n    key: \"_at\",\n    value: function _at(index) {\n      return this._children.get(index);\n    }\n  }], [{\n    key: \"isBucket\",\n    value: function isBucket(o) {\n      return o instanceof Bucket;\n    }\n  }]);\n\n  return Bucket;\n}();\n\nfunction exists(o) {\n  return Boolean(o);\n}\n\nfunction mapNode(node, index) {\n  return node.key;\n}\n\nfunction reduceNodes(nodes) {\n  return nodes;\n}\n\nfunction asyncTransformBucket(_x8, _x9, _x10) {\n  return _asyncTransformBucket.apply(this, arguments);\n}\n\nfunction _asyncTransformBucket() {\n  _asyncTransformBucket = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(bucket, asyncMap, asyncReduce) {\n    var output, _iterator3, _step3, child, mappedChildren;\n\n    return _regeneratorRuntime.wrap(function _callee7$(_context8) {\n      while (1) {\n        switch (_context8.prev = _context8.next) {\n          case 0:\n            output = [];\n            _iterator3 = _createForOfIteratorHelper(bucket._children.compactArray());\n            _context8.prev = 2;\n\n            _iterator3.s();\n\n          case 4:\n            if ((_step3 = _iterator3.n()).done) {\n              _context8.next = 18;\n              break;\n            }\n\n            child = _step3.value;\n\n            if (!(child instanceof Bucket)) {\n              _context8.next = 11;\n              break;\n            }\n\n            _context8.next = 9;\n            return asyncTransformBucket(child, asyncMap, asyncReduce);\n\n          case 9:\n            _context8.next = 15;\n            break;\n\n          case 11:\n            _context8.next = 13;\n            return asyncMap(child);\n\n          case 13:\n            mappedChildren = _context8.sent;\n            output.push({\n              bitField: bucket._children.bitField(),\n              children: mappedChildren\n            });\n\n          case 15:\n            return _context8.abrupt(\"return\", asyncReduce(output));\n\n          case 16:\n            _context8.next = 4;\n            break;\n\n          case 18:\n            _context8.next = 23;\n            break;\n\n          case 20:\n            _context8.prev = 20;\n            _context8.t0 = _context8[\"catch\"](2);\n\n            _iterator3.e(_context8.t0);\n\n          case 23:\n            _context8.prev = 23;\n\n            _iterator3.f();\n\n            return _context8.finish(23);\n\n          case 26:\n          case \"end\":\n            return _context8.stop();\n        }\n      }\n    }, _callee7, null, [[2, 20, 23, 26]]);\n  }));\n  return _asyncTransformBucket.apply(this, arguments);\n}\n\nmodule.exports = Bucket;","map":null,"metadata":{},"sourceType":"script"}