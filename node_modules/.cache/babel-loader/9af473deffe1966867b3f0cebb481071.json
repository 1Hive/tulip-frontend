{"ast":null,"code":"'use strict';\n\nconst DirSharded = require('./dir-sharded');\n\nmodule.exports = async function flatToShard(child, dir, threshold, options) {\n  let newDir = dir;\n\n  if (dir.flat && dir.directChildrenCount() >= threshold) {\n    newDir = await convertToShard(dir, options);\n  }\n\n  const parent = newDir.parent;\n\n  if (parent) {\n    if (newDir !== dir) {\n      if (child) {\n        child.parent = newDir;\n      }\n\n      await parent.put(newDir.parentKey, newDir);\n    }\n\n    return flatToShard(newDir, parent, threshold, options);\n  }\n\n  return newDir;\n};\n\nasync function convertToShard(oldDir, options) {\n  const newDir = new DirSharded({\n    root: oldDir.root,\n    dir: true,\n    parent: oldDir.parent,\n    parentKey: oldDir.parentKey,\n    path: oldDir.path,\n    dirty: oldDir.dirty,\n    flat: false,\n    mtime: oldDir.mtime,\n    mode: oldDir.mode\n  }, options);\n\n  for await (const {\n    key,\n    child\n  } of oldDir.eachChildSeries()) {\n    await newDir.put(key, child);\n  }\n\n  return newDir;\n}","map":null,"metadata":{},"sourceType":"script"}