{"ast":null,"code":"'use strict';\n\nconst errCode = require('err-code');\n\nconst UnixFS = require('ipfs-unixfs');\n\nconst findShardCid = require('../../utils/find-cid-in-shard');\n\nconst findLinkCid = (node, name) => {\n  const link = node.Links.find(link => link.Name === name);\n  return link && link.Hash;\n};\n\nconst contentExporters = {\n  raw: require('./content/file'),\n  file: require('./content/file'),\n  directory: require('./content/directory'),\n  'hamt-sharded-directory': require('./content/hamt-sharded-directory'),\n  metadata: (cid, node, unixfs, path, resolve, depth, ipld) => {},\n  symlink: (cid, node, unixfs, path, resolve, depth, ipld) => {}\n};\n\nconst unixFsResolver = async (cid, name, path, toResolve, resolve, depth, ipld, options) => {\n  const node = await ipld.get(cid, options);\n  let unixfs;\n  let next;\n\n  if (!name) {\n    name = cid.toBaseEncodedString();\n  }\n\n  try {\n    unixfs = UnixFS.unmarshal(node.Data);\n  } catch (err) {\n    // non-UnixFS dag-pb node? It could happen.\n    throw errCode(err, 'ERR_NOT_UNIXFS');\n  }\n\n  if (!path) {\n    path = name;\n  }\n\n  if (toResolve.length) {\n    let linkCid;\n\n    if (unixfs && unixfs.type === 'hamt-sharded-directory') {\n      // special case - unixfs v1 hamt shards\n      linkCid = await findShardCid(node, toResolve[0], ipld);\n    } else {\n      linkCid = findLinkCid(node, toResolve[0]);\n    }\n\n    if (!linkCid) {\n      throw errCode(new Error('file does not exist'), 'ERR_NOT_FOUND');\n    } // remove the path component we have resolved\n\n\n    const nextName = toResolve.shift();\n    const nextPath = `${path}/${nextName}`;\n    next = {\n      cid: linkCid,\n      toResolve,\n      name: nextName,\n      path: nextPath\n    };\n  }\n\n  return {\n    entry: {\n      name,\n      path,\n      cid,\n      node,\n      content: contentExporters[unixfs.type](cid, node, unixfs, path, resolve, depth, ipld, options),\n      unixfs,\n      depth\n    },\n    next\n  };\n};\n\nmodule.exports = unixFsResolver;","map":null,"metadata":{},"sourceType":"script"}