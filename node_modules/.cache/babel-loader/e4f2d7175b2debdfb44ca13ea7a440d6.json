{"ast":null,"code":"'use strict';\n\nconst distance = require('xor-distance');\n\nconst utils = require('../utils');\n\nconst pMap = require('p-map');\n/**\n * Maintains a list of peerIds sorted by distance from a DHT key.\n */\n\n\nclass PeerDistanceList {\n  /**\n   * Creates a new PeerDistanceList.\n   *\n   * @param {Buffer} originDhtKey - the DHT key from which distance is calculated\n   * @param {number} capacity - the maximum size of the list\n   */\n  constructor(originDhtKey, capacity) {\n    this.originDhtKey = originDhtKey;\n    this.capacity = capacity;\n    this.peerDistances = [];\n  }\n  /**\n   * The length of the list\n   */\n\n\n  get length() {\n    return this.peerDistances.length;\n  }\n  /**\n   * The peerIds in the list, in order of distance from the origin key\n   */\n\n\n  get peers() {\n    return this.peerDistances.map(pd => pd.peerId);\n  }\n  /**\n   * Add a peerId to the list.\n   *\n   * @param {PeerId} peerId\n   * @returns {Promise<void>}\n   */\n\n\n  async add(peerId) {\n    if (this.peerDistances.find(pd => pd.peerId.id.equals(peerId.id))) {\n      return;\n    }\n\n    const dhtKey = await utils.convertPeerId(peerId);\n    const el = {\n      peerId,\n      distance: distance(this.originDhtKey, dhtKey)\n    };\n    this.peerDistances.push(el);\n    this.peerDistances.sort((a, b) => distance.compare(a.distance, b.distance));\n    this.peerDistances = this.peerDistances.slice(0, this.capacity);\n  }\n  /**\n   * Indicates whether any of the peerIds passed as a parameter are closer\n   * to the origin key than the furthest peerId in the PeerDistanceList.\n   *\n   * @param {Array<PeerId>} peerIds\n   * @returns {Boolean}\n   */\n\n\n  async anyCloser(peerIds) {\n    if (!peerIds.length) {\n      return false;\n    }\n\n    if (!this.length) {\n      return true;\n    }\n\n    const dhtKeys = await pMap(peerIds, peerId => utils.convertPeerId(peerId));\n    const furthestDistance = this.peerDistances[this.peerDistances.length - 1].distance;\n\n    for (const dhtKey of dhtKeys) {\n      const keyDistance = distance(this.originDhtKey, dhtKey);\n\n      if (distance.compare(keyDistance, furthestDistance) < 0) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n}\n\nmodule.exports = PeerDistanceList;","map":null,"metadata":{},"sourceType":"script"}