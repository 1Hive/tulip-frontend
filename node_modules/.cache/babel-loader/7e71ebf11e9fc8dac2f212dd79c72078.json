{"ast":null,"code":"/* eslint-disable no-await-in-loop */\nimport BigNumber from 'bignumber.js';\nimport { Interface } from '@ethersproject/abi';\nimport { getWeb3 } from 'utils/web3';\nimport MultiCallAbi from 'config/abi/Multicall.json';\nimport ticketAbi from 'config/abi/lotteryNft.json';\nimport lotteryAbi from 'config/abi/lottery.json';\nimport { LOTTERY_TICKET_PRICE } from 'config';\nimport { getMulticallAddress } from './addressHelpers';\nexport const multiCall = async (abi, calls) => {\n  const web3 = getWeb3();\n  const multi = new web3.eth.Contract(MultiCallAbi, getMulticallAddress());\n  const itf = new Interface(abi);\n  let res = [];\n\n  if (calls.length > 100) {\n    let i = 0;\n\n    while (i < calls.length / 100) {\n      const newCalls = calls.slice(i * 100, 100 * (i + 1));\n      const calldata = newCalls.map(call => [call[0].toLowerCase(), itf.encodeFunctionData(call[1], call[2])]);\n      const {\n        returnData\n      } = await multi.methods.aggregate(calldata).call();\n      i++;\n      res = res.concat(returnData.map((call, index) => itf.decodeFunctionResult(newCalls[index][1], call)));\n    }\n  } else {\n    const calldata = calls.map(call => [call[0].toLowerCase(), itf.encodeFunctionData(call[1], call[2])]);\n    const {\n      returnData\n    } = await multi.methods.aggregate(calldata).call();\n    res = returnData.map((call, i) => itf.decodeFunctionResult(calls[i][1], call));\n  }\n\n  return res;\n};\nexport const multiBuy = async (lotteryContract, price, numbersList, account) => {\n  try {\n    return lotteryContract.methods.multiBuy(new BigNumber(price).times(new BigNumber(10).pow(18)).toString(), numbersList).send({\n      from: account\n    }).on('transactionHash', tx => {\n      return tx.transactionHash;\n    });\n  } catch (err) {\n    return console.error(err);\n  }\n};\nexport const getTickets = async (lotteryContract, ticketsContract, account, customLotteryNum) => {\n  const issueIndex = customLotteryNum || (await lotteryContract.methods.issueIndex().call());\n  const length = await getTicketsAmount(ticketsContract, account); // eslint-disable-next-line prefer-spread\n\n  const calls1 = Array.apply(null, {\n    length\n  }).map((a, i) => [ticketsContract.options.address, 'tokenOfOwnerByIndex', [account, i]]);\n  const res = await multiCall(ticketAbi, calls1);\n  const tokenIds = res.map(id => id.toString());\n  const calls2 = tokenIds.map(id => [ticketsContract.options.address, 'getLotteryIssueIndex', [id]]);\n  const ticketIssues = await multiCall(ticketAbi, calls2);\n  const finalTokenids = [];\n  ticketIssues.forEach(async (ticketIssue, i) => {\n    if (new BigNumber(ticketIssue).eq(issueIndex)) {\n      finalTokenids.push(tokenIds[i]);\n    }\n  });\n  const calls3 = finalTokenids.map(id => [ticketsContract.options.address, 'getLotteryNumbers', [id]]);\n  const tickets = await multiCall(ticketAbi, calls3);\n  await getLotteryStatus(lotteryContract);\n  return tickets;\n};\nexport const getTicketsAmount = async (ticketsContract, account) => {\n  return ticketsContract.methods.balanceOf(account).call();\n};\nexport const multiClaim = async (lotteryContract, ticketsContract, account) => {\n  await lotteryContract.methods.issueIndex().call();\n  const length = await getTicketsAmount(ticketsContract, account); // eslint-disable-next-line prefer-spread\n\n  const calls1 = Array.apply(null, {\n    length\n  }).map((a, i) => [ticketsContract.options.address, 'tokenOfOwnerByIndex', [account, i]]);\n  const res = await multiCall(ticketAbi, calls1);\n  const tokenIds = res.map(id => id.toString());\n  const calls2 = tokenIds.map(id => [ticketsContract.options.address, 'getClaimStatus', [id]]);\n  const claimedStatus = await multiCall(ticketAbi, calls2);\n  const unClaimedIds = tokenIds.filter((id, index) => !claimedStatus[index][0]);\n  const calls3 = unClaimedIds.map(id => [lotteryContract.options.address, 'getRewardView', [id]]);\n  const rewards = await multiCall(lotteryAbi, calls3);\n  let finanltokenIds = [];\n  rewards.forEach((r, i) => {\n    if (r > 0) {\n      finanltokenIds.push(unClaimedIds[i]);\n    }\n  });\n\n  if (finanltokenIds.length > 200) {\n    finanltokenIds = finanltokenIds.slice(0, 200);\n  }\n\n  try {\n    return lotteryContract.methods.multiClaim(finanltokenIds).send({\n      from: account\n    }).on('transactionHash', tx => {\n      return tx.transactionHash;\n    });\n  } catch (err) {\n    return console.error(err);\n  }\n};\nexport const getTotalClaim = async (lotteryContract, ticketsContract, account) => {\n  try {\n    const issueIndex = await lotteryContract.methods.issueIndex().call();\n    const length = await getTicketsAmount(ticketsContract, account); // eslint-disable-next-line prefer-spread\n\n    const calls1 = Array.apply(null, {\n      length\n    }).map((a, i) => [ticketsContract.options.address, 'tokenOfOwnerByIndex', [account, i]]);\n    const res = await multiCall(ticketAbi, calls1);\n    const tokenIds = res.map(id => id.toString());\n    const calls2 = tokenIds.map(id => [ticketsContract.options.address, 'getLotteryIssueIndex', [id]]);\n    const ticketIssues = await multiCall(ticketAbi, calls2);\n    const calls3 = tokenIds.map(id => [ticketsContract.options.address, 'getClaimStatus', [id]]);\n    const claimedStatus = await multiCall(ticketAbi, calls3);\n    const drawed = await getLotteryStatus(lotteryContract);\n    const finalTokenids = [];\n    ticketIssues.forEach(async (ticketIssue, i) => {\n      // eslint-disable-next-line no-empty\n      if (!drawed && ticketIssue.toString() === issueIndex) {} else if (!claimedStatus[i][0]) {\n        finalTokenids.push(tokenIds[i]);\n      }\n    });\n    const calls4 = finalTokenids.map(id => [lotteryContract.options.address, 'getRewardView', [id]]);\n    const rewards = await multiCall(lotteryAbi, calls4);\n    const claim = rewards.reduce((p, c) => BigNumber.sum(p, c), BigNumber(0));\n    return claim;\n  } catch (err) {\n    console.error(err);\n  }\n\n  return BigNumber(0);\n};\nexport const getTotalRewards = async lotteryContract => {\n  const issueIndex = await lotteryContract.methods.issueIndex().call();\n  return lotteryContract.methods.getTotalRewards(issueIndex).call();\n};\nexport const getMax = async lotteryContract => {\n  return lotteryContract.methods.maxNumber().call();\n};\nexport const getLotteryIssueIndex = async lotteryContract => {\n  const issueIndex = await lotteryContract.methods.issueIndex().call();\n  return issueIndex;\n};\nexport const getLotteryStatus = async lotteryContract => {\n  return lotteryContract.methods.drawed().call();\n};\nexport const getMatchingRewardLength = async (lotteryContract, matchNumber) => {\n  let issueIndex = await lotteryContract.methods.issueIndex().call();\n  const drawed = await lotteryContract.methods.drawed().call();\n\n  if (!drawed) {\n    issueIndex -= 1;\n  }\n\n  try {\n    const amount = await lotteryContract.methods.historyAmount(issueIndex, 5 - matchNumber).call();\n    return amount / 1e18 / LOTTERY_TICKET_PRICE;\n  } catch (err) {\n    console.error(err);\n  }\n\n  return 0;\n};\nexport const getWinningNumbers = async lotteryContract => {\n  const issueIndex = await lotteryContract.methods.issueIndex().call();\n  const numbers = [];\n  const drawed = await lotteryContract.methods.drawed().call();\n\n  if (!drawed && parseInt(issueIndex, 10) === 0) {\n    return [0, 0, 0, 0];\n  }\n\n  if (!drawed) {\n    for (let i = 0; i < 4; i++) {\n      numbers.push(+(await lotteryContract.methods.historyNumbers(issueIndex - 1, i).call()).toString());\n    }\n  } else {\n    for (let i = 0; i < 4; i++) {\n      numbers.push(+(await lotteryContract.methods.winningNumbers(i).call()).toString());\n    }\n  }\n\n  return numbers;\n};","map":{"version":3,"sources":["/Users/fabian/Documents/Projects/1hive/tulip-frontend/src/utils/lotteryUtils.js"],"names":["BigNumber","Interface","getWeb3","MultiCallAbi","ticketAbi","lotteryAbi","LOTTERY_TICKET_PRICE","getMulticallAddress","multiCall","abi","calls","web3","multi","eth","Contract","itf","res","length","i","newCalls","slice","calldata","map","call","toLowerCase","encodeFunctionData","returnData","methods","aggregate","concat","index","decodeFunctionResult","multiBuy","lotteryContract","price","numbersList","account","times","pow","toString","send","from","on","tx","transactionHash","err","console","error","getTickets","ticketsContract","customLotteryNum","issueIndex","getTicketsAmount","calls1","Array","apply","a","options","address","tokenIds","id","calls2","ticketIssues","finalTokenids","forEach","ticketIssue","eq","push","calls3","tickets","getLotteryStatus","balanceOf","multiClaim","claimedStatus","unClaimedIds","filter","rewards","finanltokenIds","r","getTotalClaim","drawed","calls4","claim","reduce","p","c","sum","getTotalRewards","getMax","maxNumber","getLotteryIssueIndex","getMatchingRewardLength","matchNumber","amount","historyAmount","getWinningNumbers","numbers","parseInt","historyNumbers","winningNumbers"],"mappings":"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","sourcesContent":["/* eslint-disable no-await-in-loop */\nimport BigNumber from 'bignumber.js'\nimport { Interface } from '@ethersproject/abi'\nimport { getWeb3 } from 'utils/web3'\nimport MultiCallAbi from 'config/abi/Multicall.json'\nimport ticketAbi from 'config/abi/lotteryNft.json'\nimport lotteryAbi from 'config/abi/lottery.json'\nimport { LOTTERY_TICKET_PRICE } from 'config'\nimport { getMulticallAddress } from './addressHelpers'\n\nexport const multiCall = async (abi, calls) => {\n  const web3 = getWeb3()\n  const multi = new web3.eth.Contract(MultiCallAbi, getMulticallAddress())\n  const itf = new Interface(abi)\n  let res = []\n  if (calls.length > 100) {\n    let i = 0\n    while (i < calls.length / 100) {\n      const newCalls = calls.slice(i * 100, 100 * (i + 1))\n      const calldata = newCalls.map((call) => [call[0].toLowerCase(), itf.encodeFunctionData(call[1], call[2])])\n      const { returnData } = await multi.methods.aggregate(calldata).call()\n      i++\n      res = res.concat(returnData.map((call, index) => itf.decodeFunctionResult(newCalls[index][1], call)))\n    }\n  } else {\n    const calldata = calls.map((call) => [call[0].toLowerCase(), itf.encodeFunctionData(call[1], call[2])])\n    const { returnData } = await multi.methods.aggregate(calldata).call()\n    res = returnData.map((call, i) => itf.decodeFunctionResult(calls[i][1], call))\n  }\n  return res\n}\n\nexport const multiBuy = async (lotteryContract, price, numbersList, account) => {\n  try {\n    return lotteryContract.methods\n      .multiBuy(new BigNumber(price).times(new BigNumber(10).pow(18)).toString(), numbersList)\n      .send({ from: account })\n      .on('transactionHash', (tx) => {\n        return tx.transactionHash\n      })\n  } catch (err) {\n    return console.error(err)\n  }\n}\n\nexport const getTickets = async (lotteryContract, ticketsContract, account, customLotteryNum) => {\n  const issueIndex = customLotteryNum || (await lotteryContract.methods.issueIndex().call())\n  const length = await getTicketsAmount(ticketsContract, account)\n\n  // eslint-disable-next-line prefer-spread\n  const calls1 = Array.apply(null, { length }).map((a, i) => [\n    ticketsContract.options.address,\n    'tokenOfOwnerByIndex',\n    [account, i],\n  ])\n  const res = await multiCall(ticketAbi, calls1)\n\n  const tokenIds = res.map((id) => id.toString())\n\n  const calls2 = tokenIds.map((id) => [ticketsContract.options.address, 'getLotteryIssueIndex', [id]])\n  const ticketIssues = await multiCall(ticketAbi, calls2)\n\n  const finalTokenids = []\n  ticketIssues.forEach(async (ticketIssue, i) => {\n    if (new BigNumber(ticketIssue).eq(issueIndex)) {\n      finalTokenids.push(tokenIds[i])\n    }\n  })\n  const calls3 = finalTokenids.map((id) => [ticketsContract.options.address, 'getLotteryNumbers', [id]])\n  const tickets = await multiCall(ticketAbi, calls3)\n\n  await getLotteryStatus(lotteryContract)\n  return tickets\n}\n\nexport const getTicketsAmount = async (ticketsContract, account) => {\n  return ticketsContract.methods.balanceOf(account).call()\n}\n\nexport const multiClaim = async (lotteryContract, ticketsContract, account) => {\n  await lotteryContract.methods.issueIndex().call()\n  const length = await getTicketsAmount(ticketsContract, account)\n  // eslint-disable-next-line prefer-spread\n  const calls1 = Array.apply(null, { length }).map((a, i) => [\n    ticketsContract.options.address,\n    'tokenOfOwnerByIndex',\n    [account, i],\n  ])\n  const res = await multiCall(ticketAbi, calls1)\n  const tokenIds = res.map((id) => id.toString())\n\n  const calls2 = tokenIds.map((id) => [ticketsContract.options.address, 'getClaimStatus', [id]])\n  const claimedStatus = await multiCall(ticketAbi, calls2)\n\n  const unClaimedIds = tokenIds.filter((id, index) => !claimedStatus[index][0])\n\n  const calls3 = unClaimedIds.map((id) => [lotteryContract.options.address, 'getRewardView', [id]])\n  const rewards = await multiCall(lotteryAbi, calls3)\n\n  let finanltokenIds = []\n  rewards.forEach((r, i) => {\n    if (r > 0) {\n      finanltokenIds.push(unClaimedIds[i])\n    }\n  })\n\n  if (finanltokenIds.length > 200) {\n    finanltokenIds = finanltokenIds.slice(0, 200)\n  }\n\n  try {\n    return lotteryContract.methods\n      .multiClaim(finanltokenIds)\n      .send({ from: account })\n      .on('transactionHash', (tx) => {\n        return tx.transactionHash\n      })\n  } catch (err) {\n    return console.error(err)\n  }\n}\n\nexport const getTotalClaim = async (lotteryContract, ticketsContract, account) => {\n  try {\n    const issueIndex = await lotteryContract.methods.issueIndex().call()\n    const length = await getTicketsAmount(ticketsContract, account)\n    // eslint-disable-next-line prefer-spread\n    const calls1 = Array.apply(null, { length }).map((a, i) => [\n      ticketsContract.options.address,\n      'tokenOfOwnerByIndex',\n      [account, i],\n    ])\n    const res = await multiCall(ticketAbi, calls1)\n    const tokenIds = res.map((id) => id.toString())\n    const calls2 = tokenIds.map((id) => [ticketsContract.options.address, 'getLotteryIssueIndex', [id]])\n    const ticketIssues = await multiCall(ticketAbi, calls2)\n    const calls3 = tokenIds.map((id) => [ticketsContract.options.address, 'getClaimStatus', [id]])\n    const claimedStatus = await multiCall(ticketAbi, calls3)\n\n    const drawed = await getLotteryStatus(lotteryContract)\n\n    const finalTokenids = []\n    ticketIssues.forEach(async (ticketIssue, i) => {\n      // eslint-disable-next-line no-empty\n      if (!drawed && ticketIssue.toString() === issueIndex) {\n      } else if (!claimedStatus[i][0]) {\n        finalTokenids.push(tokenIds[i])\n      }\n    })\n\n    const calls4 = finalTokenids.map((id) => [lotteryContract.options.address, 'getRewardView', [id]])\n\n    const rewards = await multiCall(lotteryAbi, calls4)\n    const claim = rewards.reduce((p, c) => BigNumber.sum(p, c), BigNumber(0))\n\n    return claim\n  } catch (err) {\n    console.error(err)\n  }\n  return BigNumber(0)\n}\n\nexport const getTotalRewards = async (lotteryContract) => {\n  const issueIndex = await lotteryContract.methods.issueIndex().call()\n  return lotteryContract.methods.getTotalRewards(issueIndex).call()\n}\n\nexport const getMax = async (lotteryContract) => {\n  return lotteryContract.methods.maxNumber().call()\n}\n\nexport const getLotteryIssueIndex = async (lotteryContract) => {\n  const issueIndex = await lotteryContract.methods.issueIndex().call()\n  return issueIndex\n}\n\nexport const getLotteryStatus = async (lotteryContract) => {\n  return lotteryContract.methods.drawed().call()\n}\n\nexport const getMatchingRewardLength = async (lotteryContract, matchNumber) => {\n  let issueIndex = await lotteryContract.methods.issueIndex().call()\n  const drawed = await lotteryContract.methods.drawed().call()\n  if (!drawed) {\n    issueIndex -= 1\n  }\n  try {\n    const amount = await lotteryContract.methods.historyAmount(issueIndex, 5 - matchNumber).call()\n    return amount / 1e18 / LOTTERY_TICKET_PRICE\n  } catch (err) {\n    console.error(err)\n  }\n  return 0\n}\n\nexport const getWinningNumbers = async (lotteryContract) => {\n  const issueIndex = await lotteryContract.methods.issueIndex().call()\n  const numbers = []\n  const drawed = await lotteryContract.methods.drawed().call()\n\n  if (!drawed && parseInt(issueIndex, 10) === 0) {\n    return [0, 0, 0, 0]\n  }\n  if (!drawed) {\n    for (let i = 0; i < 4; i++) {\n      numbers.push(+(await lotteryContract.methods.historyNumbers(issueIndex - 1, i).call()).toString())\n    }\n  } else {\n    for (let i = 0; i < 4; i++) {\n      numbers.push(+(await lotteryContract.methods.winningNumbers(i).call()).toString())\n    }\n  }\n  return numbers\n}\n"]},"metadata":{},"sourceType":"module"}